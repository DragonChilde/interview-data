# **你们数据库的高可用是怎么实现的?**

高可用，即**High Availability**，是分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计减少系统不能提供服务的时间。单机部署谈不上高可用，因为**单点故障**问题。高可用都是多个节点的，我们在考虑MySQL数据库的高可用的架构时，需要考虑这几个方面：

- 如果数据库节点宕机，需要尽快回复，保证业务不受宕机影响。
- 从数据库节点的数据，尽可能跟主节点数据实时保持一致，至少保证最终一致性。
- 数据库节点切换时，数据不能缺失。

##  主从或主主半同步复制

用双节点数据库，搭建单向或者双向的半同步复制。架构如下：

 	![](http://120.77.237.175:9080/photos/eight/mysql/01.jpg)

通常会和proxy、keepalived等第三方软件同时使用，即可以用来监控数据库的健康，又可以执行一系列管理命令。如果主库发生故障，切换到备库后仍然可以继续使用数据库。

**这种方案优点**是架构、部署比较简单，主机宕机直接切换即可。**缺点**是完全依赖于半同步复制，半同步复制退化为异步复制，无法保证数据一致性；另外，还需要额外考虑**haproxy、keepalived**的高可用机制。

## 半同步复制优化

半同步复制机制是可靠的，可以保证数据一致性的。但是如果网络发生波动，半同步复制发生超时会切换为异步复制，异复制是无法保证数据的一致性的。因此，可以在半同复制的基础上优化一下，尽可能保证半同复制。如**双通道复制**方案

![](http://120.77.237.175:9080/photos/eight/mysql/02.jpg)

## 高可用架构优化

保证高可用，可以把主从双节点数据库扩展为数据库集群。Zookeeper可以作为集群管理，它使用分布式算法保证集群数据的一致性，可以较好的避免网络分区现象的产生。

![](http://120.77.237.175:9080/photos/eight/mysql/03.jpg)

- 优点：保证了整个系统的高可用性，扩展性也较好，可以扩展为大规模集群。
- 缺点：数据一致性**仍然依赖于原生的mysql半同步复制**；引入Zookeeper使系统逻辑更复杂。

## 共享存储

> ★共享存储实现了数据库服务器和存储设备的解耦，不同数据库之间的数据同步不再依赖于MySQL的原生复制功能，而是通过磁盘数据同步的手段，来保证数据的一致性。

**DRBD磁盘复制**

DRBD是一个用软件实现的、无共享的、服务器之间镜像块设备内容的存储复制解决方案。主要用于对服务器之间的磁盘、分区、逻辑卷等进行数据镜像，当用户将数据写入本地磁盘时，还会将数据发送到网络中另一台主机的磁盘上，这样的本地主机(主节点)与远程主机(备节点)的数据就可以保证实时同步。常用架构如下：

![](http://120.77.237.175:9080/photos/eight/mysql/04.jpg)

当本地主机出现问题，远程主机上还保留着一份相同的数据，即可以继续使用，保证了数据的安全。

- 优点：部署简单，价格合适，保证数据的强一致性
- 缺点：对IO性能影响较大，从库不提供读操作

##  分布式协议

分布式协议可以很好解决数据一致性问题。常见的部署方案就是**MySQL cluster**，它是官方集群的部署方案，通过使用NDB存储引擎实时备份冗余数据，实现数据库的高可用性和数据一致性。如下：

![](http://120.77.237.175:9080/photos/eight/mysql/05.jpg)

- 优点：不依赖于第三方软件，可以实现数据的强一致性；
- 缺点：配置较复杂；需要使用NDB储存引擎；至少三节点；